# llm-sys

The `llm-sys` unit is a foundational service within the StackFlow framework. It provides essential system-level functions, including external communication channels (serial and TCP), system information retrieval, command execution, and hardware control like resets and reboots. It also internally manages port resources and a simple in-memory database for configuration.

## General API Call Conventions

All API calls to `llm-sys` are made via JSON messages. Understanding these conventions is crucial for successful interaction with the unit.

### Request Structure

A standard request to an `llm-sys` API should adhere to the following structure:

```json
{
  "request_id": "client_generated_uuid_or_counter",
  "work_id": "sys",
  "action": "api_action_name",
  // API-specific fields like "object" or "data" might be required here
}
```

-   `request_id` (string, mandatory): A unique identifier (e.g., UUID, incrementing counter) generated by the client. This ID is used to correlate requests with their corresponding responses.
-   `work_id` (string, mandatory): Specifies the target unit. For `llm-sys` APIs, this value is typically `"sys"`.
-   `action` (string, mandatory): The specific API action to be invoked within the `work_id` unit (e.g., `"ping"`, `"uartsetup"`). The combination of `work_id` and `action` effectively defines the API endpoint.
-   Other API-specific fields: Some APIs require additional fields like `object` or a `data` payload, which are detailed in their respective sections.

### Response Structure

`llm-sys` APIs provide responses that indicate the outcome of the requested operation.

**Success Response:**

A successful API call returns a JSON object with the following structure:

```json
{
  "request_id": "mirrored_from_request",
  "work_id": "sys",
  "action": "api_action_name", // Mirrored from the request
  "created": 1678886400,       // Integer: Unix timestamp of response generation
  "code": 0,                   // Integer: 0 indicates success
  "message": "OK",             // String: Success message (e.g., "OK", "Command executed")
  // "data": { ... }           // Optional: API-specific payload if the call returns data
}
```
-   `request_id`, `work_id`, `action`: Mirrored from the request.
-   `created`: Timestamp indicating when the response was generated.
-   `code`: `0` signifies that the operation was successful.
-   `message`: A human-readable success message.
-   `data` (object, optional): If the API call is expected to return data (e.g., `sys.hwinfo`, `sys.version`), it will be contained within this object.

**Error Response:**

If an API call fails, `llm-sys` returns an error response:

```json
{
  "request_id": "mirrored_from_request",
  "work_id": "sys",
  "action": "api_action_name", // Mirrored from the request
  "created": 1678886400,       // Integer: Unix timestamp of response generation
  "error": {
    "code": -1,                // Integer: Non-zero error code
    "message": "Error description" // String: Detailed error message
  }
}
```
-   `error` (object): Contains details about the failure.
    -   `code` (integer): A non-zero number representing the error type.
    -   `message` (string): A human-readable description of the error.

**Common Error Codes:**

-   `-1`: General Error / Unspecified error.
-   `-2`: Invalid Parameters (e.g., missing required fields, incorrect data types).
-   `-3`: Device/Resource Busy or Unavailable.
-   `-4`: Operation Not Supported.
-   `-5`: Timeout (e.g., internal `unit_call_timeout` reached when communicating with other services).

### Asynchronous Operations and Event Notifications

-   **Synchronicity**: Most `llm-sys` API calls are synchronous in terms of their request-response interaction. The client sends a request and waits for a response indicating the immediate outcome of the call.
-   **Asynchronous Effects**: Certain operations, by their nature, have asynchronous effects on the system state. For example:
    -   `sys.reset`: Resets the LLM framework application. The system will restart, and ongoing connections will be lost.
    -   `sys.reboot`: Restarts the entire device.
    -   `sys.bashexec`: While the API call to initiate a command might be synchronous, the command itself executes in the background and its completion is not directly tracked by the initial API response.
-   **Event Notifications**: `llm-sys` does **not** currently feature a general-purpose event notification system (e.g., via `callback_topic` as seen in `llm-audio`). Specific status messages like "upgrade over" or "reset over" are primarily designed for output on the serial console during system startup or specific operations and are not part of a general eventing API for clients. For general API interactions, clients should rely on the direct success or error responses.

## External API

This section details the external APIs provided by the `llm-sys` unit.

### **sys.ping**

-   **Description**: Tests connectivity with the `llm-sys` unit. Useful for health checks and ensuring the service is responsive.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "ping_001",
      "work_id": "sys",
      "action": "ping"
    }
    ```
-   **Response (Success)**:
    ```json
    {
      "request_id": "ping_001",
      "work_id": "sys",
      "action": "ping",
      "created": 1678886401,
      "code": 0,
      "message": "OK"
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "ping_001",
      "work_id": "sys",
      "action": "ping",
      "created": 1678886402,
      "error": {
        "code": -1,
        "message": "Failed to process ping"
      }
    }
    ```

### **sys.lsmode**

-   **Description**: Lists models that have been registered or recognized by the system. The exact source and scope of "models" (e.g., AI models, system modules) may require further context from overall system architecture. It typically lists directories found in the path specified by `config_lsmod_dir`.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "lsmode_002",
      "work_id": "sys",
      "action": "lsmode"
    }
    ```
-   **Response (Success)**: The `data` field would contain the list of models. The exact structure of this data (e.g., an array of strings, objects) is not fully defined by the provided snippets but would likely be an array of model names or objects with model details.
    ```json
    {
      "request_id": "lsmode_002",
      "work_id": "sys",
      "action": "lsmode",
      "created": 1678886403,
      "code": 0,
      "message": "OK",
      "data": {
        "models": [ "model_A", "model_B" ] // Example structure
      }
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "lsmode_002",
      "work_id": "sys",
      "action": "lsmode",
      "created": 1678886404,
      "error": {
        "code": -1,
        "message": "Failed to list modes"
      }
    }
    ```

### **sys.bashexec**

-   **Description**: Executes a shell command on the device. This API allows for powerful system interaction but should be used with caution due to security implications. It supports sending commands in chunks.
-   **Request Parameters**:

    | Parameter        | Type    | Required | Default             | Description                                                                                                |
    |------------------|---------|----------|---------------------|------------------------------------------------------------------------------------------------------------|
    | `object`         | string  | Yes      | N/A                 | Specifies the type of data stream, typically `"sys.utf-8.stream"` for plain text commands and output.        |
    | `data`           | object  | Yes      | N/A                 | Payload containing the command details.                                                                    |
    | `data.index`     | integer | Yes      | N/A                 | Sequence number for command chunks, starting from `0`. For a single, non-chunked command, use `0`.             |
    | `data.delta`     | string  | Yes      | N/A                 | The command string or a chunk of the command string.                                                       |
    | `data.finish`    | boolean | Yes      | N/A                 | Set to `true` if this is the final or only chunk of the command. Set to `false` for intermediate chunks.     |

    **Example (Single command):**
    ```json
    {
      "request_id": "bashexec_003",
      "work_id": "sys",
      "action": "bashexec",
      "object": "sys.utf-8.stream",
      "data": {
        "index": 0,
        "delta": "ls -l /tmp",
        "finish": true
      }
    }
    ```
    **Example (Chunked command - conceptual):**
    To send `echo "hello world"` in two chunks:
    Chunk 1:
    ```json
    {
      "request_id": "bashexec_004a",
      "work_id": "sys",
      "action": "bashexec",
      "object": "sys.utf-8.stream",
      "data": {
        "index": 0,
        "delta": "echo \"hello ",
        "finish": false
      }
    }
    ```
    Chunk 2:
    ```json
    {
      "request_id": "bashexec_004b",
      "work_id": "sys",
      "action": "bashexec",
      "object": "sys.utf-8.stream",
      "data": {
        "index": 1,
        "delta": "world\"",
        "finish": true
      }
    }
    ```

-   **Response (Success)**: The response indicates the command was accepted for execution. The actual output of the command is typically not sent back in this synchronous response. If command output needs to be captured, it would usually involve redirecting output to a file or another mechanism, which is not defined by this API itself.
    ```json
    {
      "request_id": "bashexec_003",
      "work_id": "sys",
      "action": "bashexec",
      "created": 1678886405,
      "code": 0,
      "message": "Command execution initiated" // Or similar
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "bashexec_003",
      "work_id": "sys",
      "action": "bashexec",
      "created": 1678886406,
      "error": {
        "code": -2,
        "message": "Invalid parameters for bashexec (e.g., missing data field)"
      }
    }
    ```

### **sys.hwinfo**

-   **Description**: Retrieves hardware information from the device, such as CPU status, memory usage, and temperature. The exact data returned can vary.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "hwinfo_004",
      "work_id": "sys",
      "action": "hwinfo"
    }
    ```
-   **Response (Success)**: The `data` object contains the hardware information. The structure below is an example; actual fields may differ.
    ```json
    {
      "request_id": "hwinfo_004",
      "work_id": "sys",
      "action": "hwinfo",
      "created": 1678886407,
      "code": 0,
      "message": "OK",
      "data": {
        "cpu_usage": "25%", // Example
        "memory_free": "2048MB", // Example
        "temperature_celsius": 45 // Example
      }
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "hwinfo_004",
      "work_id": "sys",
      "action": "hwinfo",
      "created": 1678886408,
      "error": {
        "code": -1,
        "message": "Failed to retrieve hardware information"
      }
    }
    ```

### **sys.uartsetup**

-   **Description**: Configures parameters for a serial port (UART). Settings are typically effective for the current session or until next reboot/reset. The default serial device is usually `/dev/ttyS1`.
-   **Request Parameters**:

    | Parameter     | Type    | Required | Default (from `main.cpp`) | Description                                                                                               |
    |---------------|---------|----------|---------------------------|-----------------------------------------------------------------------------------------------------------|
    | `object`      | string  | Yes      | N/A                       | Specifies the target object, typically `"sys.uartsetup"`.                                                 |
    | `data`        | object  | Yes      | N/A                       | Payload containing UART configuration.                                                                    |
    | `data.baud`   | integer | Yes      | 115200                    | Baud rate (e.g., 9600, 115200).                                                                           |
    | `data.data_bits`| integer | Yes    | 8                         | Number of data bits (e.g., 7, 8).                                                                         |
    | `data.stop_bits`| integer | Yes    | 1                         | Number of stop bits (e.g., 1, 2).                                                                         |
    | `data.parity` | integer | Yes      | 110                       | Parity setting. `110` (ASCII for 'n') means None. Other values might correspond to Even or Odd if supported. |

    **Example:**
    ```json
    {
      "request_id": "uartsetup_005",
      "work_id": "sys",
      "action": "uartsetup",
      "object": "sys.uartsetup",
      "data": {
        "baud": 115200,
        "data_bits": 8,
        "stop_bits": 1,
        "parity": 110 // 'n' for None parity
      }
    }
    ```
-   **Response (Success)**:
    ```json
    {
      "request_id": "uartsetup_005",
      "work_id": "sys",
      "action": "uartsetup",
      "created": 1678886409,
      "code": 0,
      "message": "UART configured successfully"
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "uartsetup_005",
      "work_id": "sys",
      "action": "uartsetup",
      "created": 1678886410,
      "error": {
        "code": -2,
        "message": "Invalid UART parameters (e.g., unsupported baud rate)"
      }
    }
    ```

### **sys.reset**

-   **Description**: Resets the entire LLM framework application. This will typically restart the `llm-sys` service and other related services, terminating current operations and connections.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "reset_006",
      "work_id": "sys",
      "action": "reset"
    }
    ```
-   **Response (Success)**: The success response indicates the reset command was accepted. The actual reset is an asynchronous effect.
    ```json
    {
      "request_id": "reset_006",
      "work_id": "sys",
      "action": "reset",
      "created": 1678886411,
      "code": 0,
      "message": "LLM framework reset initiated"
    }
    ```
    A message "reset over" might be sent to the serial console after the reset is complete.
-   **Response (Error)**:
    ```json
    {
      "request_id": "reset_006",
      "work_id": "sys",
      "action": "reset",
      "created": 1678886412,
      "error": {
        "code": -1,
        "message": "Failed to initiate reset"
      }
    }
    ```

### **sys.reboot**

-   **Description**: Restarts the entire device/system. This is a more drastic operation than `sys.reset`.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "reboot_007",
      "work_id": "sys",
      "action": "reboot"
    }
    ```
-   **Response (Success)**: Indicates the reboot command was accepted. The actual reboot is an asynchronous effect.
    ```json
    {
      "request_id": "reboot_007",
      "work_id": "sys",
      "action": "reboot",
      "created": 1678886413,
      "code": 0,
      "message": "System reboot initiated"
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "reboot_007",
      "work_id": "sys",
      "action": "reboot",
      "created": 1678886414,
      "error": {
        "code": -1,
        "message": "Failed to initiate reboot"
      }
    }
    ```

### **sys.version**

-   **Description**: Retrieves the version of the LLM framework program or `llm-sys` unit.
-   **Request Parameters**: None beyond the standard request structure.
    ```json
    {
      "request_id": "version_008",
      "work_id": "sys",
      "action": "version"
    }
    ```
-   **Response (Success)**: The `data` object contains version information. The structure below is an example.
    ```json
    {
      "request_id": "version_008",
      "work_id": "sys",
      "action": "version",
      "created": 1678886415,
      "code": 0,
      "message": "OK",
      "data": {
        "firmware_version": "1.2.3", // Example field
        "build_date": "2024-03-15"  // Example field
      }
    }
    ```
-   **Response (Error)**:
    ```json
    {
      "request_id": "version_008",
      "work_id": "sys",
      "action": "version",
      "created": 1678886416,
      "error": {
        "code": -1,
        "message": "Failed to retrieve version information"
      }
    }
    ```

## Relation to Configuration Files

The behavior of the `llm-sys` unit is influenced by configuration settings, primarily found in `projects/llm_framework/main_sys/sys_config.json` and default values defined within `projects/llm_framework/main_sys/src/main.cpp`.

### `sys_config.json`

-   `config_enable_tcp` (integer, 0 or 1):
    -   If set to `1` (default based on `main.cpp` if file is empty or value missing), the TCP server interface for `llm-sys` is enabled, allowing API calls over TCP.
    -   If set to `0`, the TCP server is disabled. API calls would then typically be made via other channels like serial.
    -   The default TCP server port is `10001` (from `config_tcp_server` in `main.cpp`).

### Default Settings in `main.cpp` (`get_run_config`)

The `main.cpp` file initializes a set of default parameters in an in-memory key-value store (`key_sql`) if they are not overridden by `sys_config.json` or other means. Key settings include:

-   **`config_unit_call_timeout`** (integer, default: 5000 milliseconds): This timeout is used by `remote_action.cpp` when `llm-sys` calls other units/services. If a called unit does not respond within this duration, the call may fail with a timeout error.
-   **Serial Port Defaults**:
    -   `config_serial_dev`: Default serial device (e.g., `"/dev/ttyS1"`).
    -   `config_serial_baud`: Default baud rate (e.g., `115200`).
    -   `config_serial_data_bits`: Default data bits (e.g., `8`).
    -   `config_serial_stop_bits`: Default stop bits (e.g., `1`).
    -   `config_serial_parity`: Default parity (e.g., `110` for 'n' - None).
    These defaults are used unless overridden by a `sys.uartsetup` call for a given session.
-   **ZMQ Communication**: Various `config_zmq_*` settings define IPC socket paths and port ranges for internal ZMQ-based communication.
-   **Paths**: `config_lsmod_dir` (default: `"/opt/m5stack/data/models/"`) is used by `sys.lsmode`.
-   **TCP Server**: `config_tcp_server` (default: `10001`) specifies the port for the TCP server if `config_enable_tcp` is active.

Understanding these configurations can be helpful for diagnosing issues and customizing the `llm-sys` behavior. Changes to `sys_config.json` or recompilation of `main.cpp` (for defaults) would be needed to alter these persistent settings.
